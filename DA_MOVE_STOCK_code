EXECUTE BLOCK
AS
 DECLARE VARIABLE ID_STRUCTURE TINTEGER;
 DECLARE VARIABLE ID_PARSEL TINTEGER;
 DECLARE VARIABLE ID_VAT TINTEGER;
 DECLARE VARIABLE ID_DRUG TINTEGER;
 DECLARE VARIABLE QUANT_INT TINTEGER;
 DECLARE VARIABLE QUANT_NUM TINTEGER;
 DECLARE VARIABLE QUANT_DIV TINTEGER;
 DECLARE VARIABLE QUANT_FLOAT TDOUBLE;
 DECLARE VARIABLE PRICE_SELL TDOUBLE;
 DECLARE VARIABLE PRICE_SELL_VAT TDOUBLE;
 DECLARE VARIABLE PRICE_SELL_SUM TDOUBLE;
 DECLARE VARIABLE RATE_SELL_FACTORY TDOUBLE;
 DECLARE VARIABLE RATE_SELL_BUY TDOUBLE;
 DECLARE VARIABLE AMOUNT_BUY TDOUBLE;
 DECLARE VARIABLE AMOUNT_BUY_VAT TDOUBLE;
 DECLARE VARIABLE AMOUNT_BUY_SUM TDOUBLE;
 DECLARE VARIABLE AMOUNT_SELL TDOUBLE;
 DECLARE VARIABLE AMOUNT_SELL_VAT TDOUBLE;
 DECLARE VARIABLE AMOUNT_SELL_SUM TDOUBLE;


BEGIN
update da_stock set quant_int=0, quant_num=0 where quant_int + quant_num>0
 and id_parsel=(select id from da_parsel where code='4944');-- код партии для таблицы da_stock
 FOR
SELECT
 ID_STRUCTURE,
 ID_PARSEL, 
 ID_VAT, 
 ID_DRUG, 
 QUANT_INT, 
 QUANT_NUM, 
 QUANT_DIV, 
 QUANT_FLOAT,
 PRICE_SELL, 
 PRICE_SELL_VAT,
 PRICE_SELL_SUM,
 RATE_SELL_FACTORY,
 RATE_SELL_BUY,
 AMOUNT_BUY,
 AMOUNT_BUY_VAT,
 AMOUNT_BUY_SUM,
 AMOUNT_SELL,
 AMOUNT_SELL_VAT,
 AMOUNT_SELL_SUM

FROM  DA_MOVE_STOCK  S
WHERE  ID_STRUCTURE=(SELECT id_structure FROM tmp_doc_params)
and id_parsel=(select id from da_parsel where code='4944') -- код партии таблицы DA_MOVE_STOCK
AND current_timestamp between stock_start and STOCK_CLOSE
into
 :ID_STRUCTURE,
 :ID_PARSEL,
 :ID_VAT,
 :ID_DRUG,
 :QUANT_INT,
 :QUANT_NUM,
 :QUANT_DIV,
 :QUANT_FLOAT,
 :PRICE_SELL,
 :PRICE_SELL_VAT,
 :PRICE_SELL_SUM,
 :RATE_SELL_FACTORY,
 :RATE_SELL_BUY,
 :AMOUNT_BUY,
 :AMOUNT_BUY_VAT,
 :AMOUNT_BUY_SUM,
 :AMOUNT_SELL,
 :AMOUNT_SELL_VAT,
 :AMOUNT_SELL_SUM
DO
BEGIN
UPDATE OR INSERT INTO DA_STOCK
  (ID_STRUCTURE,
   ID_PARSEL,
   ID_VAT,
   ID_DRUG,
   QUANT_INT,
   QUANT_NUM,
   QUANT_DIV,
   QUANT_FLOAT,
   PRICE_SELL,
   PRICE_SELL_VAT,
   PRICE_SELL_SUM,
   RATE_SELL_FACTORY,
   RATE_SELL_BUY,
   AMOUNT_BUY,
   AMOUNT_BUY_VAT,
   AMOUNT_BUY_SUM,
   AMOUNT_SELL,
   AMOUNT_SELL_VAT,
   AMOUNT_SELL_SUM)
                        VALUES
  (
    :ID_STRUCTURE,
 :ID_PARSEL,
 :ID_VAT,
 :ID_DRUG,
 :QUANT_INT,
 :QUANT_NUM,
 :QUANT_DIV,
 :QUANT_FLOAT,
 :PRICE_SELL,
 :PRICE_SELL_VAT,
 :PRICE_SELL_SUM,
 :RATE_SELL_FACTORY,
 :RATE_SELL_BUY,
 :AMOUNT_BUY,
 :AMOUNT_BUY_VAT,
 :AMOUNT_BUY_SUM,
 :AMOUNT_SELL,
 :AMOUNT_SELL_VAT,
 :AMOUNT_SELL_SUM
  )                    MATCHING (ID_PARSEL);


 END
END;
COMMIT WORK;
